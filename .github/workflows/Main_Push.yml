name: Main_Push

on:
  push:
    branches:
      - main


jobs:
  build_and_test:
    runs-on: macos-latest
    environment: Dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install certificates and provisioning profiles
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}          
          EXPORT_OPTS: ${{secrets.DEV_EXPORT_OPTIONS_PLIST_BASE64 }}

        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          EXPORT_OPTS_PATH=$RUNNER_TEMP/ExportOptions.plist

          echo "create variables done"

           # import certificate and provisioning profile from secrets
           # -n means remove new line characters
           # we read the base64 value of the certificate from the secret, pipe the out
           # the output is then decoded to string and sent to the path for certificate
            echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

            # here is just check if the path is valid, below lines are just for debugging
            #ls -lh "$CERTIFICATE_PATH"
            #echo "certificate exists"
            #file "$CERTIFICATE_PATH"
            #echo "check file type"

            echo 'certificate read'
            
            # now do the same with provisioning profile
            # here we are using the var defined in out env, we didn't create a var like we did for certificate
            # but we could if we want to
            echo -n "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > "$PP_PATH"
            echo "import cert and provisioning profiles done"
            
            # import export options plist
            echo -n "$EXPORT_OPTS" | base64 --decode > "$EXPORT_OPTS_PATH"

            echo "import export options plist done"

             # create keychain using macOS security CLI
             # protects it with password we created in github secrets
             # and stores it at the given path
            security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            echo "create keychain done"

            # make sure the keychain stays locked until job is done
            # set-keychain-settings changes the keychain lock/unlock settings
            # -l means lock keychain in case system goes to sleep
            # -u means enable auto lock after timeout
            # -t 21600 timeout value in seconds (6 hours)
            security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
            echo "set keychain done"
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            echo "unlock keychain done"

             # import certificates into keychain
             # import the public cert.p12 at the given path with private key protected by password
             # -P "$P12_PASSWORD" password used to decrypt the file
             # -A allow all applications e.g codesign, fastlane xcodebuild
             # -t cert identifies the item being imported
             # -f pkcs12 specifies the file format
             # -k "$KEYCHAIN_PATH" target keychain where the cert will be saved
            security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
            echo "import cert and p12 password done"

            # explicitly allows Appleâ€™s signing tools to access private keys in the keychain without prompting
            # set-key-partition-list Updates the access control list for private keys stored in a keychain. 
            # this is better -A 
            # -S apple-tool:,apple: defines which tools are trusted
            # -k "$KEYCHAIN_PASSWORD" keychain password required to modify rules
            # "$KEYCHAIN_PATH" path where the files is stored
            security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            echo "set-key-partition-list done"

            # sets which keychain the runner should look at for certs 
            # list-keychains manages keychain search list
            # -d user specifies user keychain domain
            # -s sets the keychain path
            # "$KEYCHAIN_PATH" The keychain(s) to include in the search list.
            security list-keychains -d user -s "$KEYCHAIN_PATH"
            echo "list-keychain done"

            # import provisioning profile
            # creates the directory where iOS provisioning profiles must live so Xcode can discover them for code signing.
            # -p create directory if missing, do nothing if already exists
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            # copies an iOS provisioning profile into the directory where Xcode expects to find it
            cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles

            # lists all available code-signing identities that macOS can currently use
            # find-identity Searches keychains for valid identities.
            # -p codesigning specifies the policy
            # -v verbose output
            security find-identity -p codesigning -v

            # decodes an iOS provisioning profile and prints its contents in a readable format, 
            # which is extremely useful for debugging and extracting metadata in CI
            security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision
            echo "import provisioning profile done"

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        id: spm-cache
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Build and Test
        run: |
          xcodebuild clean test -project SpaceNews/SpaceNews.xcodeproj -scheme "SpaceNews" -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 17'
            
